<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../public/css/admin2.css">
    <title>Desafío UNLaM 2</title>
</head>
<header class="main-header">
    <h1 class="logo">Desafío UNLaM</h1>
    <nav class="nav-links">
        <a href="../../admin/displayAdmin">Inicio</a>
        <a href="../../index.php?controller=login&method=logout">Cerrar Sesión</a>
    </nav>
</header>
<body>
<div class="container admin-container">
    <h2 class="title">Panel de Administración - Usuarios</h2>
    <div>
        <p class="welcome">Bienvenido, {{admin_name}}</p>
        <div class="navigation-links">
            <a href="../../admin/displayAdmin">Partidas</a>
            <a href="../../admin/displayAdminUsers">Usuarios</a>
        </div>
    </div>

    <div>
        <div class="tabla-container">
            <div class="tabla-header">
                <h3>Estadísticas de Usuarios</h3>
                <div class="botones-ordenar">
                    <button class="btn-ordenar" data-orden="id">Ordenar por ID</button>
                    <button class="btn-ordenar" data-orden="nombre">Ordenar por Nombre</button>
                    <button class="btn-ordenar active" data-orden="porcentaje">Ordenar por Porcentaje</button>
                </div>
            </div>
            <table class="tabla-usuarios">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th class="ocultar-mobile">Nombre Completo</th>
                    <th class="ocultar-mobile">Total Respuestas</th>
                    <th class="ocultar-mobile">Respuestas Correctas</th>
                    <th>Porcentaje Acierto</th>
                </tr>
                </thead>
                <tbody id="tabla-body">
                {{#usuarios_estadisticas}}
                    <tr data-id="{{id}}" data-nombre="{{nombre_usuario}}" data-porcentaje="{{porcentaje_correctas}}">
                        <td>{{id}}</td>
                        <td>{{nombre_usuario}}</td>
                        <td class="ocultar-mobile">{{nombre_completo}}</td>
                        <td class="ocultar-mobile">{{total_respuestas}}</td>
                        <td class="ocultar-mobile">{{respuestas_correctas}}</td>
                        <td>
                        <span class="porcentaje">
                            {{porcentaje_correctas}}%
                        </span>
                        </td>
                    </tr>
                {{/usuarios_estadisticas}}
                </tbody>
            </table>
            <div id="imprimir-tabla">
                <button>
                    Imprimir
                </button>
            </div>
        </div>
        <div class="cuadradote">
            <div class="cuadrado">
                <h3>Usuarios por país</h3>
                <button id="btn_pais">Ver Usuarios Por País</button>
            </div>
            <div class="cuadrado">
                <h3>Usuarios por sexo</h3>
                <button id="btn_sexo">Ver Usuarios Por Sexo</button>
            </div>
            <div class="cuadrado">
                <h3>Usuarios por edad</h3>
                <button id="btn_edad">Ver Usuarios Por Edad</button>
            </div>
        </div>

        <div id="modal_pais" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Usuarios por País</h3>
                <p>Total de usuarios: <strong>{{total_users}}</strong></p>

                <div class="filter-buttons">
                    <button class="filter-btn-pais" data-period="day">Día</button>
                    <button class="filter-btn-pais active" data-period="week">Semana</button>
                    <button class="filter-btn-pais" data-period="month">Mes</button>
                    <button class="filter-btn-pais" data-period="year">Año</button>
                </div>

                <div class="chart-container">
                    <h4 id="chart-title-pais">Distribución de Usuarios por País - Últimos 7 días</h4>
                    <canvas id="paisChart" width="400" height="200"></canvas>
                </div>

                <div class="modal-buttons">
                    <button id="btn-imprimir-pais" class="btn btn-primary">Imprimir</button>
                    <button id="btn-salir-pais" class="btn btn-secondary">Salir</button>
                </div>
            </div>
        </div>

        <div id="modal_sexo" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Usuarios por Sexo</h3>
                <p>Total de usuarios: <strong>{{total_users}}</strong></p>

                <div class="filter-buttons">
                    <button class="filter-btn-sexo" data-period="day">Día</button>
                    <button class="filter-btn-sexo active" data-period="week">Semana</button>
                    <button class="filter-btn-sexo" data-period="month">Mes</button>
                    <button class="filter-btn-sexo" data-period="year">Año</button>
                </div>

                <div class="chart-container">
                    <h4 id="chart-title-sexo">Distribución de Usuarios por Sexo - Últimos 7 días</h4>
                    <canvas id="sexoChart" width="400" height="200"></canvas>
                </div>

                <div class="modal-buttons">
                    <button id="btn-imprimir-sexo" class="btn btn-primary">Imprimir</button>
                    <button id="btn-salir-sexo" class="btn btn-secondary">Salir</button>
                </div>
            </div>
        </div>

        <div id="modal_edad" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Usuarios por Grupo de Edad</h3>
                <p>Total de usuarios: <strong>{{total_users}}</strong></p>

                <div class="filter-buttons">
                    <button class="filter-btn-edad" data-period="day">Día</button>
                    <button class="filter-btn-edad active" data-period="week">Semana</button>
                    <button class="filter-btn-edad" data-period="month">Mes</button>
                    <button class="filter-btn-edad" data-period="year">Año</button>
                </div>

                <div class="chart-container">
                    <h4 id="chart-title-edad">Distribución de Usuarios por Edad - Últimos 7 días</h4>
                    <canvas id="edadChart" width="400" height="200"></canvas>
                </div>

                <div class="modal-buttons">
                    <button id="btn-imprimir-edad" class="btn btn-primary">Imprimir</button>
                    <button id="btn-salir-edad" class="btn btn-secondary">Salir</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3>Preguntas frecuentes</h3>
            <ul>
                <li><a href="#">¿Cómo se juega?</a></li>
                <li><a href="#">Reglas</a></li>
                <li><a href="#">Puntajes</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h3>Redes sociales</h3>
            <ul>
                <li><a href="#">Instagram</a></li>
                <li><a href="#">Facebook</a></li>
                <li><a href="#">YouTube</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h3>Contacto</h3>
            <p>desafio@unlam.edu.ar</p>
        </div>
    </div>
    <p class="footer-bottom">© 2025 Desafío UNLaM — Proyecto académico</p>
</footer>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    async function imprimirTabla() {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let yPosition = margin;

            pdf.setFontSize(20);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Desafío UNLaM', margin, yPosition);
            yPosition += 7;

            pdf.setDrawColor(52, 152, 219);
            pdf.setLineWidth(1);
            pdf.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;

            pdf.setFontSize(16);
            pdf.setTextColor(52, 73, 94);
            pdf.text('Estadísticas de Usuarios', margin, yPosition);
            yPosition += 7;

            pdf.setFontSize(10);
            pdf.setTextColor(127, 140, 141);
            const fecha = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            pdf.text(`Generado el: ${fecha}`, margin, yPosition);
            yPosition += 10;

            const tbody = document.getElementById('tabla-body');
            const todasLasFilas = Array.from(document.querySelectorAll('#tabla-body tr'));

            const filas = todasLasFilas.length > 0 ? todasLasFilas :
                    Array.from(tbody.querySelectorAll('tr'));

            pdf.setFontSize(9);
            pdf.setTextColor(255, 255, 255);
            pdf.setFillColor(52, 152, 219);

            const colWidths = [15, 35, 45, 30, 30, 25];
            const headers = ['ID', 'Usuario', 'Nombre Completo', 'Total Resp.', 'Correctas', '% Acierto'];

            let xPosition = margin;
            headers.forEach((header, index) => {
                pdf.rect(xPosition, yPosition, colWidths[index], 8, 'F');
                xPosition += colWidths[index];
            });

            xPosition = margin;
            headers.forEach((header, index) => {
                pdf.text(header, xPosition + 2, yPosition + 5.5);
                xPosition += colWidths[index];
            });

            yPosition += 8;

            pdf.setTextColor(44, 62, 80);

            filas.forEach((fila, index) => {
                if (yPosition > pageHeight - 30) {
                    pdf.addPage();
                    yPosition = margin;
                }

                const celdas = fila.querySelectorAll('td');
                xPosition = margin;

                if (index % 2 === 0) {
                    pdf.setFillColor(245, 245, 245);
                    pdf.rect(margin, yPosition, pageWidth - (margin * 2), 7, 'F');
                }

                celdas.forEach((celda, colIndex) => {
                    let texto = celda.textContent.trim();


                    if (colIndex === 2 && texto.length > 20) {
                        texto = texto.substring(0, 20) + '...';
                    }
                    if (colIndex === 1 && texto.length > 15) {
                        texto = texto.substring(0, 15) + '...';
                    }

                    pdf.text(texto, xPosition + 2, yPosition + 5);
                    xPosition += colWidths[colIndex];
                });

                yPosition += 7;
            });

            const totalPaginas = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= totalPaginas; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(149, 165, 166);
                pdf.text(
                        `Página ${i} de ${totalPaginas}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                );
                pdf.text(
                        'Panel de Administración - Desafío UNLaM',
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                );
            }

            pdf.save(`estadisticas-usuarios-${new Date().toISOString().split('T')[0]}.pdf`);

        } catch (error) {
            console.error('Error al imprimir tabla:', error);
            alert('Hubo un error al generar el PDF. Por favor, intenta de nuevo.');
        }
    }
    async function generarPDF(tipo) {
        try {
            let modalId, titulo, nombreArchivo, color;

            switch(tipo) {
                case 'pais':
                    modalId = '#modal_pais';
                    titulo = document.getElementById('chart-title-pais').textContent;
                    nombreArchivo = 'reporte-usuarios-pais';
                    color = '#3498db';
                    break;
                case 'sexo':
                    modalId = '#modal_sexo';
                    titulo = document.getElementById('chart-title-sexo').textContent;
                    nombreArchivo = 'reporte-usuarios-sexo';
                    color = '#e74c3c';
                    break;
                case 'edad':
                    modalId = '#modal_edad';
                    titulo = document.getElementById('chart-title-edad').textContent;
                    nombreArchivo = 'reporte-usuarios-edad';
                    color = '#2ecc71';
                    break;
            }

            const canvas = document.querySelector(`${modalId} canvas`);
            const imgData = canvas.toDataURL('image/png', 3.0);

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 20;

            pdf.setFontSize(20);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Desafío UNLaM', margin, margin);

            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);
            pdf.setDrawColor(r, g, b);
            pdf.setLineWidth(1);
            pdf.line(margin, margin + 5, pageWidth - margin, margin + 5);

            pdf.setFontSize(16);
            pdf.setTextColor(52, 73, 94);
            pdf.text(titulo, margin, margin + 15);

            pdf.setFontSize(10);
            pdf.setTextColor(127, 140, 141);
            const fecha = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            pdf.text(`Generado el: ${fecha}`, margin, margin + 22);

            const imgWidth = pageWidth - (margin * 2);
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            const imgY = margin + 30;

            pdf.addImage(imgData, 'PNG', margin, imgY, imgWidth, imgHeight, '', 'FAST');

            pdf.setFontSize(8);
            pdf.setTextColor(149, 165, 166);
            pdf.text('Panel de Administración - Desafío UNLaM', pageWidth / 2, pageHeight - 10, { align: 'center' });

            pdf.save(`${nombreArchivo}-${new Date().toISOString().split('T')[0]}.pdf`);

        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Hubo un error al generar el PDF. Por favor, intenta de nuevo.');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('tabla-body');
        const botonesOrdenar = document.querySelectorAll('.btn-ordenar');

        let todasLasFilas = Array.from(tbody.querySelectorAll('tr'));
        let paginaActual = 1;
        const filasPorPagina = 5;

        function colorearPorcentajes() {
            const porcentajes = document.querySelectorAll('.porcentaje');
            porcentajes.forEach(function(elem) {
                const texto = elem.textContent.trim();
                const valor = parseFloat(texto.replace('%', ''));

                if (valor >= 70) {
                    elem.style.backgroundColor = '#2ecc71';
                    elem.style.color = 'white';
                } else if (valor >= 30) {
                    elem.style.backgroundColor = '#f39c12';
                    elem.style.color = 'white';
                } else {
                    elem.style.backgroundColor = '#ec564c';
                    elem.style.color = 'white';
                }
            });
        }

        function mostrarPagina(pagina) {
            const inicio = (pagina - 1) * filasPorPagina;
            const fin = inicio + filasPorPagina;

            tbody.innerHTML = '';

            const filasAMostrar = todasLasFilas.slice(inicio, fin);
            filasAMostrar.forEach(function(fila) {
                tbody.appendChild(fila.cloneNode(true));
            });

            colorearPorcentajes();
            actualizarPaginacion();
        }


        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(todasLasFilas.length / filasPorPagina);

            let paginacionDiv = document.querySelector('.paginacion');
            if (!paginacionDiv) {
                paginacionDiv = document.createElement('div');
                paginacionDiv.className = 'paginacion';
                document.querySelector('.tabla-container').appendChild(paginacionDiv);
            }

            paginacionDiv.innerHTML = '';

            const btnAnterior = document.createElement('button');
            btnAnterior.textContent = '← Anterior';
            btnAnterior.className = 'btn-pagina';
            btnAnterior.disabled = paginaActual === 1;
            btnAnterior.addEventListener('click', function() {
                if (paginaActual > 1) {
                    paginaActual--;
                    mostrarPagina(paginaActual);
                }
            });
            paginacionDiv.appendChild(btnAnterior);

            function agregarBotonPagina(numeroPagina) {
                const btnPagina = document.createElement('button');
                btnPagina.textContent = numeroPagina;
                btnPagina.className = 'btn-pagina' + (numeroPagina === paginaActual ? ' active' : '');
                btnPagina.addEventListener('click', function() {
                    paginaActual = numeroPagina;
                    mostrarPagina(paginaActual);
                });
                paginacionDiv.appendChild(btnPagina);
            }

            function agregarElipsis() {
                const elipsis = document.createElement('span');
                elipsis.textContent = '...';
                elipsis.className = 'elipsis';
                paginacionDiv.appendChild(elipsis);
            }

            if (totalPaginas <= 7) {
                for (let i = 1; i <= totalPaginas; i++) {
                    agregarBotonPagina(i);
                }
            } else {
                agregarBotonPagina(1);

                if (paginaActual <= 3) {
                    for (let i = 2; i <= 4; i++) {
                        agregarBotonPagina(i);
                    }
                    agregarElipsis();
                    agregarBotonPagina(totalPaginas);
                } else if (paginaActual >= totalPaginas - 2) {
                    agregarElipsis();
                    for (let i = totalPaginas - 3; i <= totalPaginas; i++) {
                        agregarBotonPagina(i);
                    }
                } else {
                    agregarElipsis();
                    for (let i = paginaActual - 2; i <= paginaActual + 2; i++) {
                        agregarBotonPagina(i);
                    }
                    agregarElipsis();
                    agregarBotonPagina(totalPaginas);
                }
            }

            const btnSiguiente = document.createElement('button');
            btnSiguiente.textContent = 'Siguiente →';
            btnSiguiente.className = 'btn-pagina';
            btnSiguiente.disabled = paginaActual === totalPaginas;
            btnSiguiente.addEventListener('click', function() {
                if (paginaActual < totalPaginas) {
                    paginaActual++;
                    mostrarPagina(paginaActual);
                }
            });
            paginacionDiv.appendChild(btnSiguiente);
        }

        function ordenarTabla(criterio) {
            todasLasFilas.sort(function(a, b) {
                let valorA, valorB;

                if (criterio === 'id') {
                    valorA = parseInt(a.dataset.id);
                    valorB = parseInt(b.dataset.id);
                } else if (criterio === 'nombre') {
                    valorA = a.dataset.nombre.toLowerCase();
                    valorB = b.dataset.nombre.toLowerCase();
                    return valorA.localeCompare(valorB);
                } else if (criterio === 'porcentaje') {
                    valorA = parseFloat(a.dataset.porcentaje);
                    valorB = parseFloat(b.dataset.porcentaje);
                    return valorB - valorA;
                }

                return valorA - valorB;
            });

            paginaActual = 1;
            mostrarPagina(paginaActual);
        }

        botonesOrdenar.forEach(function(boton) {
            boton.addEventListener('click', function() {
                botonesOrdenar.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const criterio = this.dataset.orden;
                ordenarTabla(criterio);
            });
        });

        mostrarPagina(1);

        const btnImprimirTabla = document.querySelector('#imprimir-tabla button');
        if (btnImprimirTabla) {
            btnImprimirTabla.addEventListener('click', imprimirTabla);
        }

        const datosPais = {
            day: JSON.parse('{{{paisDay}}}'),
            week: JSON.parse('{{{paisWeek}}}'),
            month: JSON.parse('{{{paisMonth}}}'),
            year: JSON.parse('{{{paisYear}}}')
        };

        const datosSexo = {
            day: JSON.parse('{{{sexoDay}}}'),
            week: JSON.parse('{{{sexoWeek}}}'),
            month: JSON.parse('{{{sexoMonth}}}'),
            year: JSON.parse('{{{sexoYear}}}')
        };

        const datosEdad = {
            day: JSON.parse('{{{edadDay}}}'),
            week: JSON.parse('{{{edadWeek}}}'),
            month: JSON.parse('{{{edadMonth}}}'),
            year: JSON.parse('{{{edadYear}}}')
        };

        let chartPais = null;
        let chartSexo = null;
        let chartEdad = null;

        const btnPais = document.getElementById('btn_pais');
        const modalPais = document.getElementById('modal_pais');
        const btnSalirPais = document.getElementById('btn-salir-pais');
        const btnImprimirPais = document.getElementById('btn-imprimir-pais');

        function actualizarGraficoPais(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-pais').textContent = `Distribución de Usuarios por País - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartPais) {
                    chartPais.destroy();
                    chartPais = null;
                }

                const canvas = document.getElementById('paisChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => item.pais);
            const cantidades = datos.map(item => parseInt(item.cantidad));

            const colores = [
                'rgba(52, 152, 219, 0.6)',
                'rgba(46, 204, 113, 0.6)',
                'rgba(231, 76, 60, 0.6)',
                'rgba(241, 196, 15, 0.6)',
                'rgba(155, 89, 182, 0.6)',
                'rgba(230, 126, 34, 0.6)',
                'rgba(149, 165, 166, 0.6)'
            ];

            const bordeColores = [
                '#3498db', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#e67e22', '#95a5a6'
            ];

            if (chartPais) {
                chartPais.data.labels = labels;
                chartPais.data.datasets[0].data = cantidades;
                chartPais.data.datasets[0].backgroundColor = colores.slice(0, labels.length);
                chartPais.data.datasets[0].borderColor = bordeColores.slice(0, labels.length);
                chartPais.options.plugins.title.text = `Usuarios por País - ${titulos[periodo]}`;
                chartPais.update();
            } else {
                const ctx = document.getElementById('paisChart').getContext('2d');
                chartPais = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Usuarios por País',
                            data: cantidades,
                            backgroundColor: colores.slice(0, labels.length),
                            borderColor: bordeColores.slice(0, labels.length),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            datalabels: {
                                display: true,
                                color: '#2c3e50',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                anchor: 'end',
                                align: 'start',
                                offset: -5
                            },
                            title: {
                                display: true,
                                text: `Usuarios por País - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                title: {
                                    display: true,
                                    text: 'Cantidad de Usuarios'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'País'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        btnPais.addEventListener('click', function() {
            modalPais.style.display = 'flex';

            if (!chartPais) {
                actualizarGraficoPais(datosPais.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-pais').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-pais').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoPais(datosPais[periodo], periodo);
            });
        });

        btnSalirPais.addEventListener('click', () => modalPais.style.display = 'none');
        btnImprimirPais.addEventListener('click', () => generarPDF('pais'));
        modalPais.addEventListener('click', (e) => {
            if (e.target === modalPais) modalPais.style.display = 'none';
        });

        const btnSexo = document.getElementById('btn_sexo');
        const modalSexo = document.getElementById('modal_sexo');
        const btnSalirSexo = document.getElementById('btn-salir-sexo');
        const btnImprimirSexo = document.getElementById('btn-imprimir-sexo');

        function actualizarGraficoSexo(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-sexo').textContent = `Distribución de Usuarios por Sexo - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartSexo) {
                    chartSexo.destroy();
                    chartSexo = null;
                }

                const canvas = document.getElementById('sexoChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => item.sexo);
            const cantidades = datos.map(item => parseInt(item.cantidad));

            if (chartSexo) {
                chartSexo.data.labels = labels;
                chartSexo.data.datasets[0].data = cantidades;
                chartSexo.options.plugins.title.text = `Usuarios por Sexo - ${titulos[periodo]}`;
                chartSexo.update();
            } else {
                const ctx = document.getElementById('sexoChart').getContext('2d');
                chartSexo = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: cantidades,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(231, 76, 60, 0.7)',
                                'rgba(155, 89, 182, 0.7)'
                            ],
                            borderColor: ['#3498db', '#e74c3c', '#9b59b6'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return value + '\n(' + percentage + '%)';
                                }
                            },
                            title: {
                                display: true,
                                text: `Usuarios por Sexo - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        btnSexo.addEventListener('click', function() {
            modalSexo.style.display = 'flex';

            if (!chartSexo) {
                actualizarGraficoSexo(datosSexo.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-sexo').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-sexo').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoSexo(datosSexo[periodo], periodo);
            });
        });

        btnSalirSexo.addEventListener('click', () => modalSexo.style.display = 'none');
        btnImprimirSexo.addEventListener('click', () => generarPDF('sexo'));
        modalSexo.addEventListener('click', (e) => {
            if (e.target === modalSexo) modalSexo.style.display = 'none';
        });

        const btnEdad = document.getElementById('btn_edad');
        const modalEdad = document.getElementById('modal_edad');
        const btnSalirEdad = document.getElementById('btn-salir-edad');
        const btnImprimirEdad = document.getElementById('btn-imprimir-edad');

        function actualizarGraficoEdad(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-edad').textContent = `Distribución de Usuarios por Edad - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartEdad) {
                    chartEdad.destroy();
                    chartEdad = null;
                }

                const canvas = document.getElementById('edadChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => item.rango_edad);
            const cantidades = datos.map(item => parseInt(item.cantidad));

            if (chartEdad) {
                chartEdad.data.labels = labels;
                chartEdad.data.datasets[0].data = cantidades;
                chartEdad.options.plugins.title.text = `Usuarios por Edad - ${titulos[periodo]}`;
                chartEdad.update();
            } else {
                const ctx = document.getElementById('edadChart').getContext('2d');
                chartEdad = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: cantidades,
                            backgroundColor: [
                                'rgba(241, 196, 15, 0.7)',
                                'rgba(46, 204, 113, 0.7)',
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(155, 89, 182, 0.7)'
                            ],
                            borderColor: ['#f1c40f', '#2ecc71', '#3498db', '#9b59b6'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return value + '\n(' + percentage + '%)';
                                }
                            },
                            title: {
                                display: true,
                                text: `Usuarios por Edad - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        btnEdad.addEventListener('click', function() {
            modalEdad.style.display = 'flex';

            if (!chartEdad) {
                actualizarGraficoEdad(datosEdad.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-edad').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-edad').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoEdad(datosEdad[periodo], periodo);
            });
        });

        btnSalirEdad.addEventListener('click', () => modalEdad.style.display = 'none');
        btnImprimirEdad.addEventListener('click', () => generarPDF('edad'));
        modalEdad.addEventListener('click', (e) => {
            if (e.target === modalEdad) modalEdad.style.display = 'none';
        });
    });

</script>
</body>
</html>