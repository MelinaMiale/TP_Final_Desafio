{{> header }}
<div class="profile-container">


    <div class="profile-card" id="profile-view">
        <div class="profile-header">
            <div class="profile-image">
                {{#foto_perfil}}
                    <img src="{{foto_perfil}}" alt="{{foto_perfil}}">
                {{/foto_perfil}}
                {{^foto_perfil}}
                    <div class="default-avatar">{{inicial}}</div>
                {{/foto_perfil}}
            </div>

            <div class="profile-info">
                <h2 class="username">{{nombre_usuario}}</h2>
                <p class="user-details">{{ciudad}} • {{puntos_totales}} pts</p>
                <p class="user-details">{{pais}}</p>
            </div>

            <div class="profile-qr">
                <img src="{{qr_url}}" alt="QR del perfil">
                <p class="qr-text">Escaneá para ver mi perfil</p>
            </div>
        </div>

        {{#es_propietario}}
            <button id="btnEditarPerfil" class="btn btn-primary mt-3">Editar perfil</button>
        {{/es_propietario}}
    </div>


    {{#es_propietario}}
        <div class="history-card perfil-editar mt-4" id="edit-view" style="display: none;">
            <h2>Editar perfil</h2>
            <form action="/profile/actualizarPerfil" method="POST" enctype="multipart/form-data" class="edit-form">

                <div class="form-group">
                    <label for="ciudad">Ciudad:</label>
                    <input type="text" id="ciudad" name="ciudad" value="{{ciudad}}" required>
                </div>

                <div class="form-group">
                    <label for="pais">País:</label>
                    <input type="text" id="pais" name="pais" value="{{pais}}" required>
                </div>

                <div class="form-group">
                    <label>Seleccionar ciudad y país:</label>
                    <p class="small-text">Hacé click en el mapa para actualizar tu ubicación.</p>
                    <div id="mapaEditar" style="width: 100%; height: 300px; margin-top: 10px;"></div>
                </div>

                <div class="form-group">
                    <label for="fotoPerfil">Foto de perfil:</label>
                    <input type="file" id="fotoPerfil" name="fotoPerfil" accept="image/jpeg,image/jpg,image/png">
                    {{#foto_perfil}}
                        <p>Actual: <img src="{{foto_perfil}}" alt="foto actual" width="80"></p>
                    {{/foto_perfil}}
                </div>

                <div class="form-group">
                    <label for="password">Nueva contraseña (opcional):</label>
                    <input type="password" id="password" name="password" minlength="6" placeholder="Dejar en blanco para mantener la actual">
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn btn-success">Guardar cambios</button>
                    <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    {{/es_propietario}}
    <div class="history-card mt-4">



            <h3 class="subtitle">Historial de Partidas</h3>
            <table class="game-history">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Correctas</th>
                </tr>
                </thead>
                <tbody>
                {{#partidas}}
                    <tr>
                        <td>{{date}}</td>
                        <td>{{time}}</td>
                        <td>{{correct}}</td>
                    </tr>
                {{/partidas}}
                </tbody>
            </table>

    </div>

    <a href="/playerhome/displayHome" class="btn mt-3">⬅ Volver al inicio</a>
</div>

{{> footer }}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnEditar = document.getElementById('btnEditarPerfil');
        const btnCancelar = document.getElementById('btnCancelar');
        const profileView = document.getElementById('profile-view');
        const editView = document.getElementById('edit-view');

        let mapaEditar;
        let marcadorEditar;

        function inicializarMapaEditar() {
            if (mapaEditar) return;

            mapaEditar = L.map('mapaEditar').setView([-34.6037, -58.3816], 5);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(mapaEditar);

            mapaEditar.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                const token = "pk.4bceeb166ba6748c7eae85a1eed87707";

                if (marcadorEditar) mapaEditar.removeLayer(marcadorEditar);

                marcadorEditar = L.marker([lat, lng]).addTo(mapaEditar);

                fetch(`https://us1.locationiq.com/v1/reverse?key=${token}&lat=${lat}&lon=${lng}&format=json`)
                        .then(res => res.json())
                        .then(data => {
                            let ciudad = data.address.city ||
                                    data.address.town ||
                                    data.address.village ||
                                    data.address.hamlet ||
                                    data.address.municipality ||
                                    data.address.county;

                            let pais = data.address.country;

                            document.getElementById('ciudad').value = ciudad;
                            document.getElementById('pais').value = pais;

                            marcadorEditar.bindPopup(ciudad + ', ' + pais).openPopup();
                        })
                        .catch(err => console.error(err));
            });
        }

        if (btnEditar) {
            btnEditar.addEventListener('click', () => {
                profileView.style.display = 'none';
                editView.style.display = 'block';
                setTimeout(inicializarMapaEditar, 100);
            });
        }

        if (btnCancelar) {
            btnCancelar.addEventListener('click', () => {
                editView.style.display = 'none';
                profileView.style.display = 'block';
            });
        }
    });
</script>

