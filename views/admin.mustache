<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../public/css/admin1.css">
    <title>Desafío UNLaM 1</title>
</head>
<header class="main-header">
    <h1 class="logo">Desafío UNLaM</h1>
    <nav class="nav-links">
        <a href="../../index.php?controller=playerhome&method=displayHome">Inicio</a>
        <a href="/ranking/display">Ranking</a>
        <a href="../../index.php?controller=login&method=logout">Cerrar Sesión</a>
    </nav>
</header>
<body>
<div class="container admin-container">
    <h2 class="title">Panel de Administración</h2>
    <div>
        <p class="welcome">Bienvenido, {{admin_name}}</p>
        <div class="navigation-links">
        <a href="../../index.php?controller=Admin&method=displayAdmin">Partidas</a>
        <a href="../../index.php?controller=Admin&method=displayAdminUsers">Usuarios</a>
        </div>
    </div>
    <div class="cuadradote">
        <div class="cuadrado">
            <h3>Cantidad total de jugadores</h3>
            <p class="stat-number">{{total_users}}</p>
            <button id="btn_usuarios">Ver Usuarios Nuevos</button>
        </div>

        <div class="cuadrado">
            <h3>Cantidad de partidas jugadas</h3>
            <p class="stat-number">{{total_games}}</p>
            <button id="btn_partidas">Ver Partidas Jugadas</button>
        </div>
        <div class="cuadrado">
            <h3>Cantidad de preguntas</h3>
            <p class="stat-number">{{total_questions}}</p>
            <button id="btn_preguntas">Ver Preguntas Creadas</button>
        </div>
    </div>

    <!-- MODAL DE USUARIOS -->
    <div id="modal_usuarios" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Información de Jugadores</h3>
            <p>Cantidad total de jugadores: <strong>{{total_users}}</strong></p>
            <div class="filter-buttons">
                <button class="filter-btn-usuarios" data-period="day">Día</button>
                <button class="filter-btn-usuarios active" data-period="week">Semana</button>
                <button class="filter-btn-usuarios" data-period="month">Mes</button>
                <button class="filter-btn-usuarios" data-period="year">Año</button>
            </div>

            <div class="chart-container">
                <h4 id="chart-title-usuarios">Crecimiento de Usuarios - Últimos 7 días</h4>
                <canvas id="userChart" width="400" height="200"></canvas>
            </div>

            <div class="modal-buttons">
                <button id="btn-imprimir-usuarios" class="btn btn-primary">Imprimir</button>
                <button id="btn-salir-usuarios" class="btn btn-secondary">Salir</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PARTIDAS -->
    <div id="modal_partidas" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Información de Partidas</h3>
            <p>Cantidad total de partidas: <strong>{{total_games}}</strong></p>
            <div class="filter-buttons">
                <button class="filter-btn-partidas" data-period="day">Día</button>
                <button class="filter-btn-partidas active" data-period="week">Semana</button>
                <button class="filter-btn-partidas" data-period="month">Mes</button>
                <button class="filter-btn-partidas" data-period="year">Año</button>
            </div>

            <div class="chart-container">
                <h4 id="chart-title-partidas">Partidas Jugadas - Últimos 7 días</h4>
                <canvas id="gamesChart" width="400" height="200"></canvas>
            </div>

            <div class="modal-buttons">
                <button id="btn-imprimir-partidas" class="btn btn-primary">Imprimir</button>
                <button id="btn-salir-partidas" class="btn btn-secondary">Salir</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PREGUNTAS -->
    <div id="modal_preguntas" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Información de Preguntas</h3>
            <p>Cantidad total de preguntas: <strong>{{total_questions}}</strong></p>
            <p>Cantidad total de preguntas Creadas Por Usuario: <strong>{{user_questions}}</strong></p>
            <div class="filter-buttons">
                <button class="filter-btn-preguntas" data-period="day">Día</button>
                <button class="filter-btn-preguntas active" data-period="week">Semana</button>
                <button class="filter-btn-preguntas" data-period="month">Mes</button>
                <button class="filter-btn-preguntas" data-period="year">Año</button>
            </div>

            <div class="chart-container">
                <h4 id="chart-title-preguntas">Preguntas Creadas - Últimos 7 días</h4>
                <canvas id="questionsChart" width="400" height="200"></canvas>
            </div>

            <div class="modal-buttons">
                <button id="btn-imprimir-preguntas" class="btn btn-primary">Imprimir</button>
                <button id="btn-salir-preguntas" class="btn btn-secondary">Salir</button>
            </div>
        </div>
    </div>

    <div class="close-sesion">
        <a href="?controller=login&method=logout" class="btn">Cerrar Sesión</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // ========== FUNCIÓN MEJORADA PARA GENERAR PDF ==========
    async function generarPDF(tipo) {
        try {
            let modalId, titulo, nombreArchivo, color;

            // Configuración según el tipo de reporte
            switch(tipo) {
                case 'usuarios':
                    modalId = '#modal_usuarios';
                    titulo = document.getElementById('chart-title-usuarios').textContent;
                    nombreArchivo = 'reporte-usuarios';
                    color = '#3498db';
                    break;
                case 'partidas':
                    modalId = '#modal_partidas';
                    titulo = document.getElementById('chart-title-partidas').textContent;
                    nombreArchivo = 'reporte-partidas';
                    color = '#2ecc71';
                    break;
                case 'preguntas':
                    modalId = '#modal_preguntas';
                    titulo = document.getElementById('chart-title-preguntas').textContent;
                    nombreArchivo = 'reporte-preguntas';
                    color = '#e74c3c';
                    break;
            }

            // Obtener solo el canvas del gráfico
            const canvas = document.querySelector(`${modalId} canvas`);
            const imgData = canvas.toDataURL('image/png', 3.0); // Calidad máxima

            // Crear PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 20;

            // ENCABEZADO
            pdf.setFontSize(20);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Desafío UNLaM', margin, margin);

            // LÍNEA DECORATIVA
            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);
            pdf.setDrawColor(r, g, b);
            pdf.setLineWidth(1);
            pdf.line(margin, margin + 5, pageWidth - margin, margin + 5);

            // TÍTULO DEL REPORTE
            pdf.setFontSize(16);
            pdf.setTextColor(52, 73, 94);
            pdf.text(titulo, margin, margin + 15);

            // FECHA DE GENERACIÓN
            pdf.setFontSize(10);
            pdf.setTextColor(127, 140, 141);
            const fecha = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            pdf.text(`Generado el: ${fecha}`, margin, margin + 22);

            // GRÁFICO
            const imgWidth = pageWidth - (margin * 2);
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            const imgY = margin + 30;

            pdf.addImage(imgData, 'PNG', margin, imgY, imgWidth, imgHeight, '', 'FAST');

            // PIE DE PÁGINA
            pdf.setFontSize(8);
            pdf.setTextColor(149, 165, 166);
            pdf.text('Panel de Administración - Desafío UNLaM', pageWidth / 2, pageHeight - 10, { align: 'center' });

            // GUARDAR PDF
            pdf.save(`${nombreArchivo}-${new Date().toISOString().split('T')[0]}.pdf`);

        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Hubo un error al generar el PDF. Por favor, intenta de nuevo.');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

        // ========== DATOS DE USUARIOS ==========
        const datosUsuarios = {
            day: JSON.parse('{{{datosDay}}}'),
            week: JSON.parse('{{{datosWeek}}}'),
            month: JSON.parse('{{{datosMonth}}}'),
            year: JSON.parse('{{{datosYear}}}')
        };

        // ========== DATOS DE PARTIDAS ==========
        const datosPartidas = {
            day: JSON.parse('{{{partidasDay}}}'),
            week: JSON.parse('{{{partidasWeek}}}'),
            month: JSON.parse('{{{partidasMonth}}}'),
            year: JSON.parse('{{{partidasYear}}}')
        };

        const datosPreguntas = {
            day: JSON.parse('{{{preguntasDay}}}'),
            week: JSON.parse('{{{preguntasWeek}}}'),
            month: JSON.parse('{{{preguntasMonth}}}'),
            year: JSON.parse('{{{preguntasYear}}}')
        };

        let chartUsuarios = null;
        let chartPartidas = null;
        let chartPreguntas = null;

        // Función para formatear labels
        function formatearLabel(item, periodo) {
            if (periodo === 'day') {
                return `${item.periodo}:00`;
            } else if (periodo === 'month') {
                if (item.dia && item.mes) {
                    return `${item.dia}/${mesesNombres[item.mes - 1]}`;
                }
                const fecha = new Date(item.periodo + 'T00:00:00');
                return `${fecha.getDate()}/${mesesNombres[fecha.getMonth()]}`;
            } else if (periodo === 'year') {
                if (item.mes && item.anio) {
                    return `${mesesNombres[item.mes - 1]} '${item.anio.toString().slice(-2)}`;
                }
                const [anio, mes] = item.periodo.split('-');
                return `${mesesNombres[parseInt(mes) - 1]} '${anio.slice(-2)}`;
            }
            return item.periodo;
        }

        // ========== GRÁFICO DE USUARIOS ==========
        const btnUsuarios = document.getElementById('btn_usuarios');
        const modalUsuarios = document.getElementById('modal_usuarios');
        const btnSalirUsuarios = document.getElementById('btn-salir-usuarios');
        const btnImprimirUsuarios = document.getElementById('btn-imprimir-usuarios');

        function actualizarGraficoUsuarios(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-usuarios').textContent = `Crecimiento de Usuarios - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartUsuarios) {
                    chartUsuarios.destroy();
                    chartUsuarios = null;
                }

                const canvas = document.getElementById('userChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => formatearLabel(item, periodo));
            const cantidades = datos.map(item => parseInt(item.cantidad));

            if (chartUsuarios) {
                chartUsuarios.data.labels = labels;
                chartUsuarios.data.datasets[0].data = cantidades;
                chartUsuarios.options.plugins.title.text = `Usuarios Nuevos - ${titulos[periodo]}`;
                chartUsuarios.update();
            } else {
                const ctx = document.getElementById('userChart').getContext('2d');
                chartUsuarios = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Usuarios Registrados',
                            data: cantidades,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Usuarios Nuevos - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                title: {
                                    display: true,
                                    text: 'Cantidad de Usuarios'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Fecha'
                                }
                            }
                        }
                    }
                });
            }
        }

        btnUsuarios.addEventListener('click', function() {
            modalUsuarios.style.display = 'block';

            if (!chartUsuarios) {
                actualizarGraficoUsuarios(datosUsuarios.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-usuarios').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-usuarios').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoUsuarios(datosUsuarios[periodo], periodo);
            });
        });

        btnSalirUsuarios.addEventListener('click', () => modalUsuarios.style.display = 'none');
        btnImprimirUsuarios.addEventListener('click', () => generarPDF('usuarios'));
        modalUsuarios.addEventListener('click', (e) => {
            if (e.target === modalUsuarios) modalUsuarios.style.display = 'none';
        });

        // ========== GRÁFICO DE PARTIDAS ==========
        const btnPartidas = document.getElementById('btn_partidas');
        const modalPartidas = document.getElementById('modal_partidas');
        const btnSalirPartidas = document.getElementById('btn-salir-partidas');
        const btnImprimirPartidas = document.getElementById('btn-imprimir-partidas');

        function actualizarGraficoPartidas(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-partidas').textContent = `Partidas Jugadas - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartPartidas) {
                    chartPartidas.destroy();
                    chartPartidas = null;
                }

                const canvas = document.getElementById('gamesChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => formatearLabel(item, periodo));
            const cantidades = datos.map(item => parseInt(item.cantidad));

            if (chartPartidas) {
                chartPartidas.data.labels = labels;
                chartPartidas.data.datasets[0].data = cantidades;
                chartPartidas.options.plugins.title.text = `Partidas Jugadas - ${titulos[periodo]}`;
                chartPartidas.update();
            } else {
                const ctx = document.getElementById('gamesChart').getContext('2d');
                chartPartidas = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Partidas Jugadas',
                            data: cantidades,
                            backgroundColor: 'rgba(46, 204, 113, 0.6)',
                            borderColor: '#2ecc71',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Partidas Jugadas - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                title: {
                                    display: true,
                                    text: 'Cantidad de Partidas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Fecha'
                                }
                            }
                        }
                    }
                });
            }
        }

        btnPartidas.addEventListener('click', function() {
            modalPartidas.style.display = 'block';

            if (!chartPartidas) {
                actualizarGraficoPartidas(datosPartidas.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-partidas').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-partidas').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoPartidas(datosPartidas[periodo], periodo);
            });
        });

        btnSalirPartidas.addEventListener('click', () => modalPartidas.style.display = 'none');
        btnImprimirPartidas.addEventListener('click', () => generarPDF('partidas'));
        modalPartidas.addEventListener('click', (e) => {
            if (e.target === modalPartidas) modalPartidas.style.display = 'none';
        });

        // ========== GRÁFICO DE PREGUNTAS ==========
        const btnPreguntas = document.getElementById('btn_preguntas');
        const modalPreguntas = document.getElementById('modal_preguntas');
        const btnSalirPreguntas = document.getElementById('btn-salir-preguntas');
        const btnImprimirPreguntas = document.getElementById('btn-imprimir-preguntas');

        function actualizarGraficoPreguntas(datos, periodo) {
            const titulos = {
                day: 'Últimas 24 horas',
                week: 'Últimos 7 días',
                month: 'Último mes',
                year: 'Último año'
            };

            document.getElementById('chart-title-preguntas').textContent = `Preguntas Creadas - ${titulos[periodo]}`;

            if (!datos || datos.length === 0) {
                if (chartPreguntas) {
                    chartPreguntas.destroy();
                    chartPreguntas = null;
                }

                const canvas = document.getElementById('questionsChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '18px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar en este período', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = datos.map(item => formatearLabel(item, periodo));
            const cantidades = datos.map(item => parseInt(item.cantidad));

            if (chartPreguntas) {
                chartPreguntas.data.labels = labels;
                chartPreguntas.data.datasets[0].data = cantidades;
                chartPreguntas.options.plugins.title.text = `Preguntas Creadas - ${titulos[periodo]}`;
                chartPreguntas.update();
            } else {
                const ctx = document.getElementById('questionsChart').getContext('2d');
                chartPreguntas = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Preguntas Creadas',
                            data: cantidades,
                            backgroundColor: 'rgba(231, 76, 60, 0.6)',
                            borderColor: '#e74c3c',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Preguntas Creadas - ${titulos[periodo]}`,
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                title: {
                                    display: true,
                                    text: 'Cantidad de Preguntas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Fecha'
                                }
                            }
                        }
                    }
                });
            }
        }

        btnPreguntas.addEventListener('click', function() {
            modalPreguntas.style.display = 'block';

            if (!chartPreguntas) {
                actualizarGraficoPreguntas(datosPreguntas.week, 'week');
            }
        });

        document.querySelectorAll('.filter-btn-preguntas').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn-preguntas').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const periodo = this.getAttribute('data-period');
                actualizarGraficoPreguntas(datosPreguntas[periodo], periodo);
            });
        });

        btnSalirPreguntas.addEventListener('click', () => modalPreguntas.style.display = 'none');
        btnImprimirPreguntas.addEventListener('click', () => generarPDF('preguntas'));
        modalPreguntas.addEventListener('click', (e) => {
            if (e.target === modalPreguntas) modalPreguntas.style.display = 'none';
        });
    });
</script>
</body>
</html>